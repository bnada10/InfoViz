<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Player Rating Analysis</title>
    <script src="../vendor/d3-7.8.5/dist/d3.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 30px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 16px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffe6e6;
            color: #c33;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #c33;
            margin: 20px 0;
        }

        .tabs {
            display: none;
        }

        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
            bottom: -2px;
        }

        .tab-button:hover {
            color: #667eea;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: block;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 30px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .controls.slider-controls {
            background: none;
            padding: 8px 0;
            margin-bottom: 8px;
            justify-content: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
            min-width: 120px;
        }

        .year-slider {
            min-width: 200px;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 6px;
            cursor: pointer;
        }

        .year-display {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            min-width: 50px;
        }

        .country-select {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            min-width: 180px;
        }

        .toggle-switch {
            width: 50px;
            height: 28px;
            background: #ccc;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
            border: none;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 24px;
        }

        .view-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 8px;
            flex-wrap: wrap;
            align-items: center;
            background: none;
            padding: 0;
            border-radius: 0;
        }

        .unified-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .unified-container .view-selector {
            margin-bottom: 12px;
        }

        .unified-container .slider-controls {
            margin-bottom: 20px;
        }

        .view-selector-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .view-selector label {
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .gender-display-options {
            display: flex;
            gap: 20px;
            margin-left: 20px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            min-width: auto;
        }

        .viz-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .viz-section {
            grid-column: 1 / -1;
        }

        .viz-section.half {
            grid-column: span 1;
        }

        .chart-wrapper {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            flex: 1;
            min-width: 400px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        svg {
            display: block;
            margin: 0 auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .axis {
            font-size: 12px;
        }

        .bar {
            transition: fill 0.2s;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .line-path {
            fill: none;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .line-male {
            stroke: #667eea;
        }

        .line-female {
            stroke: #ff6b9d;
        }

        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .country-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            pointer-events: none;
            z-index: 10;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #5568d3 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 10px;
            font-size: 13px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            min-width: 140px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.85);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-value {
            font-weight: 700;
            color: white;
            font-size: 20px;
            margin-top: 8px;
            font-family: 'Courier New', monospace;
        }

        .data-info {
            display: none;
        }

        @media (max-width: 768px) {
            .container { padding: 20px; }
            h1 { font-size: 22px; }
            .controls { flex-direction: column; align-items: flex-start; }
            .view-selector { flex-direction: column; align-items: flex-start; }
            .viz-container { grid-template-columns: 1fr; }
            .chart-wrapper { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>International Chess Federation ratings Analysis</h1>
       

        <div id="loadingContainer" class="loading">
            <p>Loading FIDE chess data...</p>
            <div class="spinner"></div>
        </div>

        <div id="mainContent" style="display: none;">
            <div class="data-info" id="dataInfo"></div>

            <!-- Global Distribution  -->
            <div id="q1" class="tab-content active">
                <div class="unified-container">
                    <div class="view-selector">
                        <div class="view-selector-group">
                            <label>Show Gender Comparison:</label>
                            <button class="toggle-switch" id="genderToggle"></button>
                        </div>
                        <div class="gender-display-options" id="genderDisplayOptions" style="display: none;">
                            <div class="radio-option">
                                <input type="radio" id="sameGraph" name="genderDisplay" value="same" checked>
                                <label for="sameGraph">Same Graph</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="separateGraphs" name="genderDisplay" value="separate">
                                <label for="separateGraphs">Separate Graphs</label>
                            </div>
                        </div>
                    </div>

                    <div class="controls slider-controls">
                        <div class="control-group">
                            <label>Year:</label>
                            <input type="range" id="yearSlider1" class="year-slider" min="2015" max="2025" value="2025">
                            <span class="year-display" id="yearDisplay1">2025</span>
                        </div>
                    </div>

                    <div class="viz-container">
                        <div id="globalSection" class="viz-section">
                            <div class="chart-wrapper">
                                <div class="chart-title">Global Rating Distribution</div>
                                <svg id="globalChart" width="700" height="400"></svg>
                                <div class="stats" id="globalStats"></div>
                            </div>
                        </div>

                        <div id="genderSection" class="viz-section" style="display: none;">
                        <div id="separateGenderGraphs" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; width: 100%;">
                            <div class="chart-wrapper">
                                <div class="chart-title">Male Players</div>
                                <svg id="maleChart" width="100%" height="450" style="max-width: 600px;"></svg>
                                <div class="stats" id="maleStats"></div>
                            </div>
                            <div class="chart-wrapper">
                                <div class="chart-title">Female Players</div>
                                <svg id="femaleChart" width="100%" height="450" style="max-width: 600px;"></svg>
                                <div class="stats" id="femaleStats"></div>
                            </div>
                        </div>
                        <div id="sameGenderGraph" style="display: none;">
                            <div class="chart-wrapper">
                                <div class="chart-title">Gender Comparison</div>
                                <svg id="genderComparisonChart" width="700" height="400"></svg>
                                <div class="stats" id="genderComparisonStats"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Country Trends Section -->
            <div id="q7" class="tab-content">
                <div class="viz-container">
                    <div class="viz-section">
                        <div class="chart-wrapper">
                            <div class="controls" style="margin-bottom:12px;">
                                <div class="control-group">
                                    <label>Country:</label>
                                    <select id="countrySelect" class="country-select">
                                        <option value="">Select a country...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-title">Average Rating Trend Over Time</div>
                            <svg id="countryChart" width="700" height="400"></svg>
                            <div class="stats" id="countryStats"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const config = {
            margin: { top: 20, right: 30, bottom: 40, left: 60 },
            width: 550,
            height: 350,
            binSize: 50,
            colors: { global: '#667eea', male: '#667eea', female: '#ff6b9d' }
        };

        let allData = [], metadata = {}, allYears = [];
        let showGenderComparison = false;
        let genderDisplayMode = 'same'; // 'same' or 'separate'
        let globalMinRating = 800, globalMaxRating = 2800; // Will be calculated from data

        async function loadData() {
            try {
                console.log('Attempting to load chess_data_aggregated.json...');
                const response = await fetch('chess_data_aggregated.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const jsonData = await response.json();
                metadata = jsonData.metadata;
                allData = jsonData.data;
                
                console.log(' Data loaded successfully');
                console.log('Records:', allData.length);
                console.log('Countries:', metadata.countries.length);
                console.log('Years:', metadata.year_range.min, '-', metadata.year_range.max);
                
                return true;
            } catch (error) {
                console.error(' Error loading data:', error);
                document.getElementById('loadingContainer').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
                return false;
            }
        }

        async function init() {
            if (!await loadData()) return;

            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            // Get years
            allYears = [...new Set(allData.map(d => d.year))].sort((a, b) => a - b);
            const minYear = Math.min(...allYears);
            const maxYear = Math.max(...allYears);

            // Calculate global min and max ratings from entire dataset
            globalMinRating = Math.floor(d3.min(allData, d => d.mean_rating) / 50) * 50; // Round down to nearest 50
            globalMaxRating = Math.ceil(d3.max(allData, d => d.mean_rating) / 50) * 50; // Round up to nearest 50

            // Update sliders
            document.getElementById('yearSlider1').min = minYear;
            document.getElementById('yearSlider1').max = maxYear;
            document.getElementById('yearSlider1').value = maxYear;
            document.getElementById('yearDisplay1').textContent = maxYear;

            // Populate countries
            metadata.countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                document.getElementById('countrySelect').appendChild(option);
            });

            // Setup event listeners
            document.getElementById('yearSlider1').addEventListener('input', (e) => {
                const year = parseInt(e.target.value);
                document.getElementById('yearDisplay1').textContent = year;
                drawGlobalView(year);
            });

            document.getElementById('genderToggle').addEventListener('click', (e) => {
                showGenderComparison = !showGenderComparison;
                e.target.classList.toggle('active');
                const genderSection = document.getElementById('genderSection');
                const globalSection = document.getElementById('globalSection');
                const displayOptions = document.getElementById('genderDisplayOptions');
                
                if (showGenderComparison) {
                    genderSection.style.display = 'block';
                    globalSection.style.display = 'none';
                    displayOptions.style.display = 'flex';
                    const year = parseInt(document.getElementById('yearSlider1').value);
                    drawQ9(year);
                } else {
                    genderSection.style.display = 'none';
                    globalSection.style.display = 'block';
                    displayOptions.style.display = 'none';
                    const year = parseInt(document.getElementById('yearSlider1').value);
                    drawGlobalView(year);
                }
            });

            // Gender display mode selection
            document.querySelectorAll('input[name="genderDisplay"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    genderDisplayMode = e.target.value;
                    const year = parseInt(document.getElementById('yearSlider1').value);
                    drawQ9(year);
                });
            });

            document.getElementById('countrySelect').addEventListener('change', (e) => {
                if (e.target.value) {
                    drawQ7(e.target.value);
                }
            });

            // Initial draws
            drawGlobalView(maxYear);
        }

        function createHistogram(yearData) {
            const minRating = 800, maxRating = 2800, binSize = 50;
            const bins = [];
            
            for (let i = minRating; i < maxRating; i += binSize) {
                bins.push({ start: i, end: i + binSize, count: 0 });
            }
            
            yearData.forEach(d => {
                const binIndex = Math.floor((d.mean_rating - minRating) / binSize);
                if (binIndex >= 0 && binIndex < bins.length) {
                    bins[binIndex].count += d.count;
                }
            });
            
            return bins.filter(b => b.count > 0);
        }

        function drawHistogram(svgId, data, color, minRating = null, maxRating = null) {
            const svg = d3.select(`#${svgId}`);
            svg.selectAll('*').remove();

            if (!data || data.length === 0) {
                svg.append('text')
                    .attr('x', config.width / 2)
                    .attr('y', config.height / 2)
                    .attr('text-anchor', 'middle')
                    .text('No data');
                return;
            }

            // Get actual SVG dimensions
            const svgElement = document.getElementById(svgId);
            const width = svgElement.clientWidth || config.width;
            const height = svgElement.clientHeight || config.height;
            const margin = config.margin;

            // Use provided min/max ratings or calculate from data
            const xMin = minRating !== null ? minRating : data[0].start;
            const xMax = maxRating !== null ? maxRating + 100 : data[data.length - 1].end;

            const xScale = d3.scaleLinear()
                .domain([xMin, xMax])
                .range([margin.left, width - margin.right]);

            // Find actual max of the data to properly scale y-axis with padding
            const maxCount = d3.max(data, d => d.count);
            const yScale = d3.scaleLinear()
                .domain([0, maxCount * 1.1]) // 10% padding above max to prevent bars from being cut off
                .range([height - margin.bottom, margin.top]);

            const barWidth = xScale(data[0].end) - xScale(data[0].start) - 2;

            // Ensure a tooltip element exists
            let tooltip = d3.select('.tooltip');
            if (tooltip.empty()) {
                tooltip = d3.select('body').append('div')
                    .attr('class', 'tooltip')
                    .style('display', 'none');
            }

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', d => xScale(d.start) + 1)
                .attr('y', d => yScale(d.count))
                .attr('width', barWidth)
                .attr('height', d => height - margin.bottom - yScale(d.count))
                .attr('fill', color)
                .attr('opacity', 0.7)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this).attr('opacity', 1);
                    tooltip.style('display', 'block')
                        .html(`<strong>Range:</strong> ${d.start} - ${d.end}<br/><strong>Count:</strong> ${d.count.toLocaleString()}`)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mousemove', function(event, d) {
                    tooltip.style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function(event, d) {
                    d3.select(this).attr('opacity', 0.7);
                    tooltip.style('display', 'none');
                });

            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .append('text')
                .attr('x', width / 2)
                .attr('y', 35)
                .attr('fill', 'black')
                .text('Rating');

            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScale))
                .append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', -50)
                .attr('fill', 'black')
                .text('Players');
        }

        function drawQ1(year) {
            const yearData = allData.filter(d => d.year === year);
            const hist = createHistogram(yearData);
            drawHistogram('globalChart', hist, config.colors.global, globalMinRating, globalMaxRating);

            const totalPlayers = d3.sum(yearData, d => d.count);
            const avgRating = d3.mean(yearData, d => d.mean_rating);
            
            const statsHtml = `
                <div class="stat-box">
                    <div class="stat-label">Total Players</div>
                    <div class="stat-value">${totalPlayers.toLocaleString()}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Avg Rating</div>
                    <div class="stat-value">${Math.round(avgRating)}</div>
                </div>
            `;
            document.getElementById('globalStats').innerHTML = statsHtml;
        }

        function drawGlobalView(year) {
            if (showGenderComparison) {
                drawQ9(year);
            } else {
                drawQ1(year);
            }
        }

        function drawQ9(year) {
            const yearData = allData.filter(d => d.year === year);
            const maleData = yearData.filter(d => d.gender === 'M');
            const femaleData = yearData.filter(d => d.gender === 'F');

            const malePlayers = d3.sum(maleData, d => d.count);
            const femalePlayers = d3.sum(femaleData, d => d.count);

            if (genderDisplayMode === 'separate') {
                // Show separate histograms
                document.getElementById('separateGenderGraphs').style.display = 'grid';
                document.getElementById('sameGenderGraph').style.display = 'none';

                const maleHist = createHistogram(maleData);
                const femaleHist = createHistogram(femaleData);

                drawHistogram('maleChart', maleHist, config.colors.male, globalMinRating, globalMaxRating);
                drawHistogram('femaleChart', femaleHist, config.colors.female, globalMinRating, globalMaxRating);

                document.getElementById('maleStats').innerHTML = `
                    <div class="stat-box">
                        <div class="stat-label">Players</div>
                        <div class="stat-value">${malePlayers.toLocaleString()}</div>
                    </div>
                `;

                document.getElementById('femaleStats').innerHTML = `
                    <div class="stat-box">
                        <div class="stat-label">Players</div>
                        <div class="stat-value">${femalePlayers.toLocaleString()}</div>
                    </div>
                `;
            } else {
                // Show combined graph with overlapping lines
                document.getElementById('separateGenderGraphs').style.display = 'none';
                document.getElementById('sameGenderGraph').style.display = 'block';

                drawCombinedGenderHistogram('genderComparisonChart', maleData, femaleData);

                document.getElementById('genderComparisonStats').innerHTML = `
                    <div class="stat-box">
                        <div class="stat-label">Male Players</div>
                        <div class="stat-value">${malePlayers.toLocaleString()}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Female Players</div>
                        <div class="stat-value">${femalePlayers.toLocaleString()}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total</div>
                        <div class="stat-value">${(malePlayers + femalePlayers).toLocaleString()}</div>
                    </div>
                `;
            }
        }

        function drawCombinedGenderHistogram(svgId, maleData, femaleData) {
            const maleHist = createHistogram(maleData);
            const femaleHist = createHistogram(femaleData);

            const svg = d3.select(`#${svgId}`);
            svg.selectAll('*').remove();

            if ((!maleHist || maleHist.length === 0) && (!femaleHist || femaleHist.length === 0)) {
                svg.append('text')
                    .attr('x', config.width / 2)
                    .attr('y', config.height / 2)
                    .attr('text-anchor', 'middle')
                    .text('No data');
                return;
            }

            const width = 700, height = 400, margin = config.margin;

            // Combine data to find overall min/max
            const allBins = [...(maleHist || []), ...(femaleHist || [])];
            
            // Use global min/max ratings for consistent coordinate system across all years
            const xScale = d3.scaleLinear()
                .domain([globalMinRating, globalMaxRating + 100]) // Global scale with padding
                .range([margin.left, width - margin.right]);

            const maxCount = Math.max(
                d3.max(maleHist || [], d => d.count) || 0,
                d3.max(femaleHist || [], d => d.count) || 0
            );

            const yScale = d3.scaleLinear()
                .domain([0, maxCount])
                .range([height - margin.bottom, margin.top]);

            // Ensure tooltip exists for gender histograms
            let tooltip = d3.select('.tooltip');
            if (tooltip.empty()) {
                tooltip = d3.select('body').append('div')
                    .attr('class', 'tooltip')
                    .style('display', 'none');
            }

            // Draw male bars
            if (maleHist && maleHist.length > 0) {
                const barWidth = xScale(maleHist[0].end) - xScale(maleHist[0].start) - 4;
                svg.selectAll('.bar-male')
                    .data(maleHist)
                    .enter()
                    .append('rect')
                    .attr('class', 'bar-male')
                    .attr('x', d => xScale(d.start) + 1)
                    .attr('y', d => yScale(d.count))
                    .attr('width', barWidth / 2)
                    .attr('height', d => height - margin.bottom - yScale(d.count))
                    .attr('fill', config.colors.male)
                    .attr('opacity', 0.7)
                    .style('cursor', 'pointer')
                    .on('mouseover', function(event, d) {
                        d3.select(this).attr('opacity', 1);
                        tooltip.style('display', 'block')
                            .html(`<strong>Range:</strong> ${d.start} - ${d.end}<br/><strong>Count:</strong> ${d.count.toLocaleString()}`)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 28) + 'px');
                    })
                    .on('mousemove', function(event, d) {
                        tooltip.style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 28) + 'px');
                    })
                    .on('mouseout', function(event, d) {
                        d3.select(this).attr('opacity', 0.7);
                        tooltip.style('display', 'none');
                    });
            }

            // Draw female bars
            if (femaleHist && femaleHist.length > 0) {
                const barWidth = xScale(femaleHist[0].end) - xScale(femaleHist[0].start) - 4;
                svg.selectAll('.bar-female')
                    .data(femaleHist)
                    .enter()
                    .append('rect')
                    .attr('class', 'bar-female')
                    .attr('x', d => xScale(d.start) + 1 + barWidth / 4)
                    .attr('y', d => yScale(d.count))
                    .attr('width', barWidth / 2)
                    .attr('height', d => height - margin.bottom - yScale(d.count))
                    .attr('fill', config.colors.female)
                    .attr('opacity', 0.7)
                    .style('cursor', 'pointer')
                    .on('mouseover', function(event, d) {
                        d3.select(this).attr('opacity', 1);
                        tooltip.style('display', 'block')
                            .html(`<strong>Range:</strong> ${d.start} - ${d.end}<br/><strong>Count:</strong> ${d.count.toLocaleString()}`)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 28) + 'px');
                    })
                    .on('mousemove', function(event, d) {
                        tooltip.style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 28) + 'px');
                    })
                    .on('mouseout', function(event, d) {
                        d3.select(this).attr('opacity', 0.7);
                        tooltip.style('display', 'none');
                    });
            }

            // Add legend
            svg.append('rect')
                .attr('x', width - margin.right - 150)
                .attr('y', margin.top)
                .attr('width', 140)
                .attr('height', 80)
                .attr('fill', 'white')
                .attr('stroke', '#ddd')
                .attr('rx', 4);

            svg.append('rect')
                .attr('x', width - margin.right - 140)
                .attr('y', margin.top + 10)
                .attr('width', 15)
                .attr('height', 15)
                .attr('fill', config.colors.male)
                .attr('opacity', 0.7);

            svg.append('text')
                .attr('x', width - margin.right - 120)
                .attr('y', margin.top + 22)
                .attr('font-size', '12px')
                .text('Male');

            svg.append('rect')
                .attr('x', width - margin.right - 140)
                .attr('y', margin.top + 35)
                .attr('width', 15)
                .attr('height', 15)
                .attr('fill', config.colors.female)
                .attr('opacity', 0.7);

            svg.append('text')
                .attr('x', width - margin.right - 120)
                .attr('y', margin.top + 47)
                .attr('font-size', '12px')
                .text('Female');

            // Add axes
            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .append('text')
                .attr('x', width / 2)
                .attr('y', 35)
                .attr('fill', 'black')
                .text('Rating');

            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScale))
                .append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', -50)
                .attr('fill', 'black')
                .text('Players');
        }

        function drawQ7(country) {
            let countryData = allData.filter(d => d.country === country);

            const byYear = d3.rollup(countryData, v => ({
                avg: d3.mean(v, d => d.mean_rating),
                count: d3.sum(v, d => d.count)
            }), d => d.year);

            const trendData = Array.from(byYear, ([year, vals]) => ({
                year, avg: vals.avg, count: vals.count
            })).sort((a, b) => a.year - b.year);

            const svg = d3.select('#countryChart');
            svg.selectAll('*').remove();

            if (trendData.length === 0) return;

            const margin = { top: 20, right: 30, bottom: 40, left: 60 };
            const width = 700, height = 400;

            const xScale = d3.scaleLinear()
                .domain([d3.min(trendData, d => d.year), d3.max(trendData, d => d.year)])
                .range([margin.left, width - margin.right]);

            // Use fixed y-axis scale so it doesn't change when selecting different countries
            const yScale = d3.scaleLinear()
                .domain([1200, 2100])
                .range([height - margin.bottom, margin.top]);

            const line = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.avg));

            // Create or get tooltip element
            let tooltip = d3.select('.country-tooltip');
            if (tooltip.empty()) {
                tooltip = d3.select('body').append('div')
                    .attr('class', 'country-tooltip')
                    .style('display', 'none');
            }

            svg.append('path')
                .datum(trendData)
                .attr('d', line)
                .attr('stroke', config.colors.global)
                .attr('stroke-width', 2)
                .attr('fill', 'none');

            svg.selectAll('.dot')
                .data(trendData)
                .enter()
                .append('circle')
                .attr('cx', d => xScale(d.year))
                .attr('cy', d => yScale(d.avg))
                .attr('r', 4)
                .attr('fill', config.colors.global)
                .style('cursor', 'pointer')
                .on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('r', 6)
                        .attr('fill', '#ff6b9d');

                    tooltip.style('display', 'block')
                        .html(`<strong>Year:</strong> ${d.year}<br/><strong>Avg Rating:</strong> ${d.avg.toFixed(1)}`)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mousemove', function(event, d) {
                    tooltip.style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('r', 4)
                        .attr('fill', config.colors.global);

                    tooltip.style('display', 'none');
                });

            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale));

            // X-axis label
            svg.append('text')
                .attr('x', (width - margin.left - margin.right) / 2 + margin.left)
                .attr('y', height - 5)
                .attr('text-anchor', 'middle')
                .attr('font-size', '12px')
                .attr('fill', '#333')
                .text('Year');

            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScale));

            // Y-axis label
            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 10)
                .attr('x', -(height / 2))
                .attr('text-anchor', 'middle')
                .attr('font-size', '12px')
                .attr('fill', '#333')
                .text('Average Rating');

            const totalPlayers = d3.sum(countryData, d => d.count);
            const avgRating = d3.mean(countryData, d => d.mean_rating);

            document.getElementById('countryStats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-label">Total Records</div>
                    <div class="stat-value">${totalPlayers.toLocaleString()}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Avg Rating</div>
                    <div class="stat-value">${Math.round(avgRating)}</div>
                </div>
            `;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>