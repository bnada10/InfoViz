<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Player Rating Analysis</title>
    <script src="../vendor/d3-7.8.5/dist/d3.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 30px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 16px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffe6e6;
            color: #c33;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #c33;
            margin: 20px 0;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
            bottom: -2px;
        }

        .tab-button:hover {
            color: #667eea;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
            min-width: 120px;
        }

        .year-slider {
            min-width: 200px;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 6px;
            cursor: pointer;
        }

        .year-display {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            min-width: 50px;
        }

        .country-select {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            min-width: 180px;
        }

        .toggle-switch {
            width: 50px;
            height: 28px;
            background: #ccc;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 24px;
        }

        .viz-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .chart-wrapper {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            flex: 1;
            min-width: 400px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        svg {
            display: block;
            margin: 0 auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .axis {
            font-size: 12px;
        }

        .bar {
            transition: fill 0.2s;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .line-path {
            fill: none;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .line-male {
            stroke: #667eea;
        }

        .line-female {
            stroke: #ff6b9d;
        }

        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stat-box {
            background: white;
            padding: 12px 16px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            font-size: 13px;
        }

        .stat-label {
            color: #666;
            font-size: 11px;
            text-transform: uppercase;
        }

        .stat-value {
            font-weight: bold;
            color: #333;
            font-size: 16px;
            margin-top: 4px;
        }

        .data-info {
            background: #e8f0fe;
            border-left: 4px solid #667eea;
            padding: 12px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 20px;
            color: #333;
        }

        @media (max-width: 768px) {
            .container { padding: 20px; }
            h1 { font-size: 22px; }
            .controls { flex-direction: column; align-items: flex-start; }
            .chart-wrapper { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chess Player Rating Analysis System</h1>
        <p class="subtitle">Comprehensive analysis across three perspectives: global, gender comparison, and country trends</p>

        <div id="loadingContainer" class="loading">
            <p>Loading FIDE chess data...</p>
            <div class="spinner"></div>
        </div>

        <div id="mainContent" style="display: none;">
            <div class="data-info" id="dataInfo"></div>

            <div class="tabs">
                <button class="tab-button active" data-tab="q1">Q1: Global Distribution</button>
                <button class="tab-button" data-tab="q9">Q9: Gender Comparison</button>
                <button class="tab-button" data-tab="q7">Q7: Country Trends</button>
            </div>

            <div id="q1" class="tab-content active">
                <div class="controls">
                    <div class="control-group">
                        <label>Year:</label>
                        <input type="range" id="yearSlider1" class="year-slider" min="2015" max="2025" value="2025">
                        <span class="year-display" id="yearDisplay1">2025</span>
                    </div>
                </div>
                <div class="viz-container">
                    <div class="chart-wrapper">
                        <div class="chart-title">Global Rating Distribution</div>
                        <svg id="globalChart" width="600" height="400"></svg>
                        <div class="stats" id="globalStats"></div>
                    </div>
                </div>
            </div>

            <div id="q9" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <label>Year:</label>
                        <input type="range" id="yearSlider2" class="year-slider" min="2015" max="2025" value="2025">
                        <span class="year-display" id="yearDisplay2">2025</span>
                    </div>
                </div>
                <div class="viz-container">
                    <div class="chart-wrapper">
                        <div class="chart-title">Male Players</div>
                        <svg id="maleChart" width="600" height="400"></svg>
                        <div class="stats" id="maleStats"></div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="chart-title">Female Players</div>
                        <svg id="femaleChart" width="600" height="400"></svg>
                        <div class="stats" id="femaleStats"></div>
                    </div>
                </div>
            </div>

            <div id="q7" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <label>Country:</label>
                        <select id="countrySelect" class="country-select">
                            <option value="">Select a country...</option>
                        </select>
                    </div>
                </div>
                <div class="viz-container">
                    <div class="chart-wrapper">
                        <div class="chart-title">Average Rating Trend Over Time</div>
                        <svg id="countryChart" width="700" height="400"></svg>
                        <div class="stats" id="countryStats"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const config = {
            margin: { top: 20, right: 30, bottom: 40, left: 60 },
            width: 550,
            height: 350,
            binSize: 50,
            colors: { global: '#667eea', male: '#667eea', female: '#ff6b9d' }
        };

        let allData = [], metadata = {}, allYears = [];

        async function loadData() {
            try {
                console.log('Attempting to load chess_data_aggregated.json...');
                const response = await fetch('chess_data_aggregated.json');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const jsonData = await response.json();
                metadata = jsonData.metadata;
                allData = jsonData.data;
                
                console.log('✓ Data loaded successfully');
                console.log('Records:', allData.length);
                console.log('Countries:', metadata.countries.length);
                console.log('Years:', metadata.year_range.min, '-', metadata.year_range.max);
                
                return true;
            } catch (error) {
                console.error('✗ Error loading data:', error);
                document.getElementById('loadingContainer').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
                return false;
            }
        }

        async function init() {
            if (!await loadData()) return;

            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';

            // Update data info
            const info = `${allData.length} records | ${metadata.countries.length} countries | Years: ${metadata.year_range.min}-${metadata.year_range.max}`;
            document.getElementById('dataInfo').textContent = info;

            // Get years
            allYears = [...new Set(allData.map(d => d.year))].sort((a, b) => a - b);
            const minYear = Math.min(...allYears);
            const maxYear = Math.max(...allYears);

            // Update sliders
            document.getElementById('yearSlider1').min = minYear;
            document.getElementById('yearSlider1').max = maxYear;
            document.getElementById('yearSlider1').value = maxYear;
            document.getElementById('yearDisplay1').textContent = maxYear;

            document.getElementById('yearSlider2').min = minYear;
            document.getElementById('yearSlider2').max = maxYear;
            document.getElementById('yearSlider2').value = maxYear;
            document.getElementById('yearDisplay2').textContent = maxYear;

            // Populate countries
            metadata.countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                document.getElementById('countrySelect').appendChild(option);
            });

            // Setup event listeners
            document.getElementById('yearSlider1').addEventListener('input', (e) => {
                const year = parseInt(e.target.value);
                document.getElementById('yearDisplay1').textContent = year;
                drawQ1(year);
            });

            document.getElementById('yearSlider2').addEventListener('input', (e) => {
                const year = parseInt(e.target.value);
                document.getElementById('yearDisplay2').textContent = year;
                drawQ9(year);
            });

            document.getElementById('countrySelect').addEventListener('change', (e) => {
                if (e.target.value) drawQ7(e.target.value);
            });

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(e.target.getAttribute('data-tab')).classList.add('active');
                });
            });

            // Initial draws
            drawQ1(maxYear);
            drawQ9(maxYear);
        }

        function createHistogram(yearData) {
            const minRating = 800, maxRating = 2800, binSize = 50;
            const bins = [];
            
            for (let i = minRating; i < maxRating; i += binSize) {
                bins.push({ start: i, end: i + binSize, count: 0 });
            }
            
            yearData.forEach(d => {
                const binIndex = Math.floor((d.mean_rating - minRating) / binSize);
                if (binIndex >= 0 && binIndex < bins.length) {
                    bins[binIndex].count += d.count;
                }
            });
            
            return bins.filter(b => b.count > 0);
        }

        function drawHistogram(svgId, data, color) {
            const svg = d3.select(`#${svgId}`);
            svg.selectAll('*').remove();

            if (!data || data.length === 0) {
                svg.append('text')
                    .attr('x', config.width / 2)
                    .attr('y', config.height / 2)
                    .attr('text-anchor', 'middle')
                    .text('No data');
                return;
            }

            const width = config.width, height = config.height, margin = config.margin;

            const xScale = d3.scaleLinear()
                .domain([data[0].start, data[data.length - 1].end])
                .range([margin.left, width - margin.right]);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.count)])
                .range([height - margin.bottom, margin.top]);

            const barWidth = xScale(data[0].end) - xScale(data[0].start) - 2;

            svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('class', 'bar')
                .attr('x', d => xScale(d.start) + 1)
                .attr('y', d => yScale(d.count))
                .attr('width', barWidth)
                .attr('height', d => height - margin.bottom - yScale(d.count))
                .attr('fill', color)
                .attr('opacity', 0.7);

            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale))
                .append('text')
                .attr('x', width / 2)
                .attr('y', 35)
                .attr('fill', 'black')
                .text('Rating');

            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScale))
                .append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', -50)
                .attr('fill', 'black')
                .text('Players');
        }

        function drawQ1(year) {
            const yearData = allData.filter(d => d.year === year);
            const hist = createHistogram(yearData);
            drawHistogram('globalChart', hist, config.colors.global);

            const totalPlayers = d3.sum(yearData, d => d.count);
            const avgRating = d3.mean(yearData, d => d.mean_rating);
            
            const statsHtml = `
                <div class="stat-box">
                    <div class="stat-label">Total Players</div>
                    <div class="stat-value">${totalPlayers.toLocaleString()}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Avg Rating</div>
                    <div class="stat-value">${Math.round(avgRating)}</div>
                </div>
            `;
            document.getElementById('globalStats').innerHTML = statsHtml;
        }

        function drawQ9(year) {
            const yearData = allData.filter(d => d.year === year);
            const maleData = yearData.filter(d => d.gender === 'M');
            const femaleData = yearData.filter(d => d.gender === 'F');

            const maleHist = createHistogram(maleData);
            const femaleHist = createHistogram(femaleData);

            drawHistogram('maleChart', maleHist, config.colors.male);
            drawHistogram('femaleChart', femaleHist, config.colors.female);

            const malePlayers = d3.sum(maleData, d => d.count);
            const femalePlayers = d3.sum(femaleData, d => d.count);

            document.getElementById('maleStats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-label">Players</div>
                    <div class="stat-value">${malePlayers.toLocaleString()}</div>
                </div>
            `;

            document.getElementById('femaleStats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-label">Players</div>
                    <div class="stat-value">${femalePlayers.toLocaleString()}</div>
                </div>
            `;
        }

        function drawQ7(country) {
            const countryData = allData.filter(d => d.country === country);
            const byYear = d3.rollup(countryData, v => ({
                avg: d3.mean(v, d => d.mean_rating),
                count: d3.sum(v, d => d.count)
            }), d => d.year);

            const trendData = Array.from(byYear, ([year, vals]) => ({
                year, avg: vals.avg, count: vals.count
            })).sort((a, b) => a.year - b.year);

            const svg = d3.select('#countryChart');
            svg.selectAll('*').remove();

            if (trendData.length === 0) return;

            const margin = { top: 20, right: 30, bottom: 40, left: 60 };
            const width = 700, height = 400;

            const xScale = d3.scaleLinear()
                .domain([d3.min(trendData, d => d.year), d3.max(trendData, d => d.year)])
                .range([margin.left, width - margin.right]);

            const yScale = d3.scaleLinear()
                .domain([1500, 1800])
                .range([height - margin.bottom, margin.top]);

            const line = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.avg));

            svg.append('path')
                .datum(trendData)
                .attr('d', line)
                .attr('stroke', config.colors.global)
                .attr('stroke-width', 2)
                .attr('fill', 'none');

            svg.selectAll('.dot')
                .data(trendData)
                .enter()
                .append('circle')
                .attr('cx', d => xScale(d.year))
                .attr('cy', d => yScale(d.avg))
                .attr('r', 4)
                .attr('fill', config.colors.global);

            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(xScale));

            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(yScale));

            const totalPlayers = d3.sum(countryData, d => d.count);
            const avgRating = d3.mean(countryData, d => d.mean_rating);

            document.getElementById('countryStats').innerHTML = `
                <div class="stat-box">
                    <div class="stat-label">Total Records</div>
                    <div class="stat-value">${totalPlayers.toLocaleString()}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Avg Rating</div>
                    <div class="stat-value">${Math.round(avgRating)}</div>
                </div>
            `;
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>